{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% load pagination %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <a href="{% url 'pets:pet_list' %}" class="btn btn-outline-primary">
      <i class="fas fa-arrow-left"></i> <span class="ms-2">{% trans "Back to list" %}</span>
    </a>
    <h1 class="m-0">{{ pet.name }}</h1>
    {% if pet.species %}
      <small class="text-muted">{{ pet.species }}{% if pet.breed %}, {{ pet.breed }}{% endif %}</small>
    {% endif %}
  </div>
  <div>
    <a href="{% url 'pets:pet_update' pet.id %}" class="btn btn-secondary">{% trans "Edit" %}</a>
    <a href="{% url 'pets:pet_delete' pet.id %}" class="btn btn-danger">{% trans "Delete" %}</a>
  </div>
</div>

<div class="row">
  <div class="col-md-4 mb-3">
    {% if pet.avatar %}
      <img src="{{ pet.avatar.url }}" alt="Avatar of {{ pet.name }}" class="img-thumbnail w-100 mb-3">
    {% else %}
      <img src="{% static 'default_pet_avatar.png' %}" class="card-img-top" alt="No Avatar">
    {% endif %}

    <p><strong>{% trans "Birth Date" %}:</strong> {{ pet.birth_date|default:"-" }}</p>
    <p><strong>{% trans "Chip Number" %}:</strong> {{ pet.chip_number|default:"-" }}</p>
    <p><strong>{% trans "Notes" %}:</strong> {{ pet.notes|default:"-" }}</p>
    <p><strong>{% trans "Confirmed Diagnoses" %}:</strong> {{ pet.confirmed_diagnoses|default:"-" }}</p>
    <p><strong>{% trans "Current Prescriptions" %}:</strong> {{ pet.current_prescriptions|default:"-" }}</p>
    <p><strong>{% trans "Caregiver" %}:</strong>
      {% if pet.caregiver %}
        {{ pet.caregiver.first_name }} {{ pet.caregiver.last_name }}
      {% else %}
        - 
      {% endif %}
    </p>
  </div>

  <div class="col-md-8">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item">
        <a 
          class="nav-link {% if active_tab|default:"tasks" == "tasks" %}active{% endif %}"
          href="?tab=tasks" 
          role="tab"
        >
          {% trans "Tasks" %}
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link {% if active_tab == "weight" %}active{% endif %}"
          href="?tab=weight"
          role="tab"
        >
          {% trans "Weight Log" %}
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link {% if active_tab == "photos" %}active{% endif %}"
          href="?tab=photos"
          role="tab"
        >
          {% trans "Photo Gallery" %}
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link {% if active_tab == "vaccinations" %}active{% endif %}"
          href="?tab=vaccinations"
          role="tab"
        >
          {% trans "Vaccination Log" %}
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link {% if active_tab == "documents" %}active{% endif %}"
          href="?tab=documents"
          role="tab"
        >
          {% trans "Pet Documents" %}
        </a>
      </li>
    </ul>

    <div class="tab-content border border-top-0 p-3">
      <!-- TASKS TAB -->
      {% if active_tab|default:"tasks" == "tasks" %}
        <div class="tab-pane fade show active" id="tasks">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">{% trans "Tasks" %}</h5>
            <a href="{% url 'pets:task_create' pet.id %}" class="btn btn-info">
              {% trans "Add Task" %}
            </a>
          </div>

          <!-- "Show/hide old" and "per_page" switches -->
          <div class="mb-3 d-flex justify-content-between">
            <div>
              {% if show_old == "1" %}
                <a 
                  href="?tab=tasks&show_old=0&per_page_tasks={{ per_page_tasks }}" 
                  class="btn btn-outline-secondary"
                >
                  {% trans "Hide old tasks" %}
                </a>
              {% else %}
                <a 
                  href="?tab=tasks&show_old=1&per_page_tasks={{ per_page_tasks }}" 
                  class="btn btn-outline-secondary"
                >
                  {% trans "Show old tasks" %}
                </a>
              {% endif %}
            </div>
            <div>
              <form method="get" class="d-inline">
                <!-- Saves current tab and show_old value upon per_page selection -->
                <input type="hidden" name="tab" value="tasks">
                <input type="hidden" name="show_old" value="{{ show_old }}">

                <label for="id_per_page_tasks">{% trans "Per page" %}:</label>
                <select name="per_page_tasks" id="id_per_page_tasks" onchange="this.form.submit()">
                  <option value="10" {% if per_page_tasks == "10" %}selected{% endif %}>10</option>
                  <option value="25" {% if per_page_tasks == "25" %}selected{% endif %}>25</option>
                  <option value="50" {% if per_page_tasks == "50" %}selected{% endif %}>50</option>
                </select>
              </form>
            </div>
          </div>

          {% if page_obj_tasks.object_list %}
            <form method="POST" action="{% url 'pets:task_bulk_status' pet.id %}?tab=tasks&show_old={{ show_old }}&per_page_tasks={{ per_page_tasks }}">
              {% csrf_token %}
              <input type="hidden" name="bulk_update" value="1">

              <table class="table table-bordered table-sm">
                <thead>
                  <tr>
                    <th style="width: 40px;"></th>
                    <th>{% trans "Title" %}</th>
                    <th>{% trans "Due Date/Time" %}</th>
                    <th>{% trans "Status" %}</th>
                    <th style="width: 160px;">{% trans "Actions" %}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for task in page_obj_tasks.object_list %}
                    <tr>    
                      <td>
                        {% if task.status == 'planned' or task.status == 'overdue' %}
                          <input type="checkbox" name="task_ids" value="{{ task.id }}">
                        {% endif %}
                      </td>
                      <td>{{ task.title }}</td>
                      <td>
                        {% if task.due_datetime %}{{ task.due_datetime }}{% else %}-{% endif %}
                      </td>
                      <td>
                        {% if task.status == 'planned' %}
                          <span class="badge bg-primary">{% trans "Planned" %}</span>
                        {% elif task.status == 'overdue' %}
                          <span class="badge bg-danger">{% trans "Overdue" %}</span>
                        {% elif task.status == 'done' %}
                          <span class="badge bg-success">{% trans "Done" %}</span>
                        {% elif task.status == 'skipped' %}
                          <span class="badge bg-secondary">{% trans "Skipped" %}</span>
                        {% endif %}
                      </td>
                      <td>
                        <a href="{% url 'pets:task_edit' task.id %}" class="btn btn-sm btn-secondary">
                          {% trans "Edit" %}
                        </a>
                        {% if request.user == pet.owner %}
                          <a href="{% url 'pets:task_delete' task.id %}" class="btn btn-sm btn-danger ms-1">
                            {% trans "Delete" %}
                          </a>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>

              <div class="mt-2">
                <button type="submit" name="action" value="done" class="btn btn-success btn-sm">
                  {% trans "Mark as Done" %}
                </button>
                <button type="submit" name="action" value="skipped" class="btn btn-warning btn-sm">
                  {% trans "Mark as Skipped" %}
                </button>
              </div>
            </form>

            {% render_pagination page_obj_tasks "tasks" "per_page_tasks" "page_tasks" %}
          {% else %}
            <p class="text-muted">{% trans "No tasks available." %}</p>
          {% endif %}
        </div>
      {% endif %}

      <!-- WEIGHT LOG TAB -->
      {% if active_tab == "weight" %}
        <div class="tab-pane fade show active" id="weight">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">{% trans "Weight Log" %}</h5>
            <a href="{% url 'pets:weight_create' pet.id %}" class="btn btn-success">
              {% trans "Add Weight" %}
            </a>
          </div>

          <div class="mb-3 d-flex justify-content-end">
            <form method="get" class="d-inline">
              <input type="hidden" name="tab" value="weight">
              <label for="id_per_page_weight">{% trans "Per page" %}:</label>
              <select name="per_page_weight" id="id_per_page_weight" onchange="this.form.submit()">
                <option value="10" {% if per_page_weight == "10" %}selected{% endif %}>10</option>
                <option value="25" {% if per_page_weight == "25" %}selected{% endif %}>25</option>
                <option value="50" {% if per_page_weight == "50" %}selected{% endif %}>50</option>
              </select>
            </form>
          </div>

          {% if page_obj_weight.object_list %}
            <table class="table table-striped table-sm">
              <thead>
                <tr>
                  <th>{% trans "Date" %}</th>
                  <th>{% trans "Weight (kg)" %}</th>
                  {% if request.user == pet.owner %}
                    <th>{% trans "Actions" %}</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for wl in page_obj_weight.object_list %}
                  <tr>
                    <td>{{ wl.date }}</td>
                    <td>{{ wl.weight_kg }} kg</td>
                    {% if request.user == pet.owner %}
                      <td>
                        <a href="{% url 'pets:weight_edit' wl.id %}" class="btn btn-sm btn-secondary">
                          {% trans "Edit" %}
                        </a>
                        <a href="{% url 'pets:weight_delete' wl.id %}" class="btn btn-sm btn-danger ms-1">
                          {% trans "Delete" %}
                        </a>
                      </td>
                    {% endif %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>

            {% render_pagination page_obj_weight "weight" "per_page_weight" "page_weight" %}
          {% else %}
            <p class="text-muted">{% trans "No weight logs available." %}</p>
          {% endif %}
        </div>
      {% endif %}

      <!-- PHOTOS TAB -->
      {% if active_tab == "photos" %}
        <div class="tab-pane fade show active" id="photos">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">{% trans "Photo Gallery" %}</h5>
            <!-- Open modal window -->
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadPhotoModal">
              {% trans "Upload Photo" %}
            </button>
          </div>

          <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-3">
            {% for photo in photos %}
              <div class="col">
                <div class="card">
                  <div style="height: 200px; overflow: hidden;">
                    {% if pet.owner == request.user or pet.caregiver == request.user %}
                      <!-- Open modal window -->
                      <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal{{ photo.id }}">
                        <img src="{{ photo.path.url }}" alt="Photo of {{ pet.name }}" 
                             style="object-fit: scale-down; width: 100%; height: 100%;">
                      </a>
                    {% else %}
                      <img src="{{ photo.path.url }}" alt="Photo of {{ pet.name }}" 
                           style="object-fit: scale-down; width: 100%; height: 100%;">
                    {% endif %}
                  </div>
                  {% if pet.owner == request.user or pet.caregiver == request.user %}
                    <div class="modal fade" id="imageModal{{ photo.id }}" tabindex="-1" aria-labelledby="imageModalLabel{{ photo.id }}" aria-hidden="true">
                      <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="imageModalLabel{{ photo.id }}">{{ photo.path.name }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
                          </div>
                          <div class="modal-body text-center">
                            <img src="{{ photo.path.url }}" alt="Photo of {{ pet.name }}" class="img-fluid">
                          </div>
                          <div class="modal-footer justify-content-between">
                            <a href="{% url 'pets:protected_media' pet.id photo.image_name %}?download=1" 
                               class="btn btn-primary">
                              {% trans "Download" %}
                            </a>
                            <a href="{% url 'pets:delete_pet_image' pet.id photo.id %}?tab={{ active_tab }}" 
                               class="btn btn-danger" 
                               onclick="return confirm('{% trans "Are you sure you want to delete this image?" %}');">
                              {% trans "Delete" %}
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>

        <div class="modal fade" id="uploadPhotoModal" tabindex="-1" aria-labelledby="uploadPhotoModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <form method="post" enctype="multipart/form-data" action="{% url 'pets:photo_upload' pet.id %}">
                {% csrf_token %}
                <div class="modal-header">
                  <h5 class="modal-title" id="uploadPhotoModalLabel">{% trans "Upload Photo" %}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
                </div>
                <div class="modal-body">
                  {{ form.as_p }}
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                  <button type="submit" class="btn btn-primary">{% trans "Upload" %}</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- VACCINATIONS TAB -->
      {% if active_tab == "vaccinations" %}
        <div class="tab-pane fade show active" id="vaccinations">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">{% trans "Vaccination Log" %}</h5>
            <a href="{% url 'pets:vaccination_create' pet.id %}" class="btn btn-warning">
              {% trans "Add Vaccination" %}
            </a>
          </div>

          <div class="mb-3 d-flex justify-content-end">
            <form method="get" class="d-inline">
              <input type="hidden" name="tab" value="vaccinations">
              <label for="id_per_page_vaccinations">{% trans "Per page" %}:</label>
              <select name="per_page_vaccinations" id="id_per_page_vaccinations" onchange="this.form.submit()">
                <option value="10" {% if per_page_vaccinations == "10" %}selected{% endif %}>10</option>
                <option value="25" {% if per_page_vaccinations == "25" %}selected{% endif %}>25</option>
                <option value="50" {% if per_page_vaccinations == "50" %}selected{% endif %}>50</option>
              </select>
            </form>
          </div>

          {% if page_obj_vaccinations.object_list %}
            <table class="table table-bordered table-sm">
              <thead>
                <tr>
                  <th>{% trans "Date Administered" %}</th>
                  <th>{% trans "Vaccine Name" %}</th>
                  <th>{% trans "Next Due Date" %}</th>
                  <th>{% trans "Notes" %}</th>
                  {% if request.user == pet.owner %}
                    <th>{% trans "Actions" %}</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for vac in page_obj_vaccinations.object_list %}
                  <tr>
                    <td>{{ vac.date_administered }}</td>
                    <td>{{ vac.vaccine_name }}</td>
                    <td>{{ vac.next_due_date|default:"-" }}</td>
                    <td>{{ vac.notes|default:"-" }}</td>
                    {% if request.user == pet.owner %}
                      <td>
                        <a href="{% url 'pets:vaccination_edit' vac.id %}" class="btn btn-sm btn-secondary">
                          {% trans "Edit" %}
                        </a>
                        <a href="{% url 'pets:vaccination_delete' vac.id %}" class="btn btn-sm btn-danger ms-1">
                          {% trans "Delete" %}
                        </a>
                      </td>
                    {% endif %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>

            {% render_pagination page_obj_vaccinations "vaccinations" "per_page_vaccinations" "page_vaccinations" %}
          {% else %}
            <p class="text-muted">{% trans "No vaccination logs available." %}</p>
          {% endif %}
        </div>
      {% endif %}

      <!-- DOCUMENTS TAB -->
      {% if active_tab == "documents" %}
        <div class="tab-pane fade show active" id="documents">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">{% trans "Pet Documents" %}</h5>
            <a href="{% url 'pets:document_upload' pet.id %}" class="btn btn-info">
              {% trans "Add Document" %}
            </a>
          </div>

          <div class="mb-3 d-flex justify-content-end">
            <form method="get" class="d-inline">
              <input type="hidden" name="tab" value="documents">
              <label for="id_per_page_documents">{% trans "Per page" %}:</label>
              <select name="per_page_documents" id="id_per_page_documents" onchange="this.form.submit()">
                <option value="10" {% if per_page_documents == "10" %}selected{% endif %}>10</option>
                <option value="25" {% if per_page_documents == "25" %}selected{% endif %}>25</option>
                <option value="50" {% if per_page_documents == "50" %}selected{% endif %}>50</option>
              </select>
            </form>
          </div>

          {% if page_obj_documents.object_list %}
            <table class="table table-hover table-sm">
              <thead>
                <tr>
                  <th>{% trans "Document Date" %}</th>
                  <th>{% trans "Type" %}</th>
                  <th>{% trans "Description" %}</th>
                  <th>{% trans "File" %}</th>
                  {% if request.user == pet.owner %}
                    <th>{% trans "Actions" %}</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for doc in page_obj_documents.object_list %}
                  <tr>
                    <td>{{ doc.doc_date }}</td>
                    <td>{{ doc.get_doc_type_display }}</td>
                    <td>{{ doc.description|default:"-" }}</td>
                    <td>
                      <a href="{{ doc.doc_file.url }}" target="_blank">
                        {% trans "Download" %}
                      </a>
                    </td>
                    {% if request.user == pet.owner %}
                      <td>
                        <a href="{% url 'pets:document_edit' doc.id %}" class="btn btn-sm btn-secondary">
                          {% trans "Edit" %}
                        </a>
                        <a href="{% url 'pets:document_delete' doc.id %}" class="btn btn-sm btn-danger ms-1">
                          {% trans "Delete" %}
                        </a>
                      </td>
                    {% endif %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>

            {% render_pagination page_obj_documents "documents" "per_page_documents" "page_documents" %}
          {% else %}
            <p class="text-muted">{% trans "No pet documents available." %}</p>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
