{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="m-0">{{ pet.name }}</h1>
    {% if pet.species %}<small class="text-muted">{{ pet.species }}{% if pet.breed %}, {{ pet.breed }}{% endif %}</small>{% endif %}
  </div>
  <div>
    <a href="{% url 'pets:pet_update' pet.id %}" class="btn btn-secondary">{% trans "Edit" %}</a>
    <a href="{% url 'pets:pet_delete' pet.id %}" class="btn btn-danger">{% trans "Delete" %}</a>
    <a href="{% url 'pets:pet_list' %}" class="btn btn-outline-primary">{% trans "Back to list" %}</a>
  </div>
</div>

<div class="row">
  <div class="col-md-4 mb-3">
    {% if pet.avatar %}
      <img src="{{ pet.avatar.url }}" alt="Avatar of {{ pet.name }}" class="img-thumbnail w-100 mb-3">
    {% endif %}

    <p><strong>{% trans "Birth Date" %}:</strong> {{ pet.birth_date|default:"-" }}</p>
    <p><strong>{% trans "Chip Number" %}:</strong> {{ pet.chip_number|default:"-" }}</p>
    <p><strong>{% trans "Notes" %}:</strong> {{ pet.notes|default:"-" }}</p>
    <p><strong>{% trans "Confirmed Diagnoses" %}:</strong> {{ pet.confirmed_diagnoses|default:"-" }}</p>
    <p><strong>{% trans "Current Prescriptions" %}:</strong> {{ pet.current_prescriptions|default:"-" }}</p>
  </div>

  <div class="col-md-8">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item">
        <a 
          class="nav-link {% if active_tab|default:"tasks" == "tasks" %}active{% endif %}"
          href="?tab=tasks" 
          role="tab"
        >
          {% trans "Tasks" %}
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link {% if active_tab == "weight" %}active{% endif %}"
          href="?tab=weight"
          role="tab"
        >
          {% trans "Weight Log" %}
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link {% if active_tab == "photos" %}active{% endif %}"
          href="?tab=photos"
          role="tab"
        >
          {% trans "Photo Gallery" %}
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link {% if active_tab == "vaccinations" %}active{% endif %}"
          href="?tab=vaccinations"
          role="tab"
        >
          {% trans "Vaccination Log" %}
        </a>
      </li>
      <li class="nav-item">
        <a
          class="nav-link {% if active_tab == "documents" %}active{% endif %}"
          href="?tab=documents"
          role="tab"
        >
          {% trans "Pet Documents" %}
        </a>
      </li>
    </ul>

    <div class="tab-content border border-top-0 p-3">
      <!-- TASKS TAB -->
      {% if active_tab|default:"tasks" == "tasks" %}
          <div class="tab-pane fade show active" id="tasks">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="m-0">{% trans "Tasks" %}</h5>
              <a href="{% url 'pets:task_create' pet.id %}" class="btn btn-info">
                {% trans "Add Task" %}
              </a>
            </div>
        
            <!-- "Show/hide old" and "per_page" switches -->
            <div class="mb-3 d-flex justify-content-between">
              <div>
                {% if show_old == "1" %}
                  <a 
                    href="?tab=tasks&show_old=0&per_page={{ per_page }}" 
                    class="btn btn-outline-secondary"
                  >
                    {% trans "Hide old tasks" %}
                  </a>
                {% else %}
                  <a 
                    href="?tab=tasks&show_old=1&per_page={{ per_page }}" 
                    class="btn btn-outline-secondary"
                  >
                    {% trans "Show old tasks" %}
                  </a>
                {% endif %}
              </div>
              <div>
                <form method="get" class="d-inline">
                  <!-- Saving current tab and show_old on per_page selection -->
                  <input type="hidden" name="tab" value="tasks">
                  <input type="hidden" name="show_old" value="{{ show_old }}">
        
                  <label for="id_per_page">{% trans "Per page" %}:</label>
                  <select name="per_page" id="id_per_page" onchange="this.form.submit()">
                    <option value="10" {% if per_page == "10" %}selected{% endif %}>10</option>
                    <option value="25" {% if per_page == "25" %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page == "50" %}selected{% endif %}>50</option>
                  </select>
                </form>
              </div>
            </div>
        
            <!-- MAss status update form -->
            <form method="POST" action="?tab=tasks&show_old={{ show_old }}&per_page={{ per_page }}">
              {% csrf_token %}
              <input type="hidden" name="bulk_update" value="1">
        
              <table class="table table-bordered table-sm">
                <thead>
                  <tr>
                    <th style="width: 40px;"></th>
                    <th>{% trans "Title" %}</th>
                    <th>{% trans "Due Date/Time" %}</th>
                    <th>{% trans "Status" %}</th>
                    <th style="width: 160px;">{% trans "Actions" %}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for task in page_obj %}
                    <tr>
                      <td>
                        {% if task.status == 'planned' or task.status == 'overdue' %}
                          <input type="checkbox" name="task_ids" value="{{ task.id }}">
                        {% endif %}
                      </td>
                      <td>{{ task.title }}</td>
                      <td>
                        {% if task.due_datetime %}{{ task.due_datetime }}{% endif %}
                      </td>
                      <td>
                        {% if task.status == 'planned' %}
                          <span class="badge bg-primary">{% trans "Planned" %}</span>
                        {% elif task.status == 'overdue' %}
                          <span class="badge bg-danger">{% trans "Overdue" %}</span>
                        {% elif task.status == 'done' %}
                          <span class="badge bg-success">{% trans "Done" %}</span>
                        {% elif task.status == 'skipped' %}
                          <span class="badge bg-secondary">{% trans "Skipped" %}</span>
                        {% endif %}
                      </td>
                      <td>
                        <a href="{% url 'pets:task_edit' task.id %}" class="btn btn-sm btn-secondary">
                          {% trans "Edit" %}
                        </a>
                        <a 
                          href="{% url 'pets:task_delete' task.id %}" 
                          class="btn btn-sm btn-danger ms-1"
                        >
                          {% trans "Delete" %}
                        </a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
        
              <div class="mt-2">
                <button type="submit" name="action" value="done" class="btn btn-success btn-sm">
                  {% trans "Mark as Done" %}
                </button>
                <button type="submit" name="action" value="skipped" class="btn btn-warning btn-sm">
                  {% trans "Mark as Skipped" %}
                </button>
              </div>
            </form>
        
            <!-- Pagination -->
            <nav class="mt-3">
              <ul class="pagination">
                {% if page_obj.has_previous %}
                  <li class="page-item">
                    <a 
                      class="page-link" 
                      href="?tab=tasks&show_old={{ show_old }}&per_page={{ per_page }}&page={{ page_obj.previous_page_number }}"
                    >
                      {% trans "Previous" %}
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link">{% trans "Previous" %}</span>
                  </li>
                {% endif %}
        
                {% for num in page_obj.paginator.page_range %}
                  {% if page_obj.number == num %}
                    <li class="page-item active">
                      <span class="page-link">{{ num }}</span>
                    </li>
                  {% else %}
                    <li class="page-item">
                      <a 
                        class="page-link" 
                        href="?tab=tasks&show_old={{ show_old }}&per_page={{ per_page }}&page={{ num }}"
                      >
                        {{ num }}
                      </a>
                    </li>
                  {% endif %}
                {% endfor %}
        
                {% if page_obj.has_next %}
                  <li class="page-item">
                    <a 
                      class="page-link" 
                      href="?tab=tasks&show_old={{ show_old }}&per_page={{ per_page }}&page={{ page_obj.next_page_number }}"
                    >
                      {% trans "Next" %}
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link">{% trans "Next" %}</span>
                  </li>
                {% endif %}
              </ul>
            </nav>
        
          </div>
        {% endif %}


      <!-- WEIGHT TAB -->
      {% if active_tab == "weight" %}
        <div class="tab-pane fade show active" id="weight">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">{% trans "Weight Log" %}</h5>
            <a href="{% url 'pets:weight_create' pet.id %}" class="btn btn-success">
              {% trans "Add Weight" %}
            </a>
          </div>
          <table class="table table-striped table-sm">
            <thead>
              <tr>
                <th>{% trans "Date" %}</th>
                <th>{% trans "Weight (kg)" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for wl in weight_logs %}
                <tr>
                  <td>{{ wl.date }}</td>
                  <td>{{ wl.weight_kg }} kg</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}

      <!-- PHOTOS TAB -->
      {% if active_tab == "photos" %}
        <div class="tab-pane fade show active" id="photos">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">{% trans "Photo Gallery" %}</h5>
            <a href="{% url 'pets:photo_upload' pet.id %}" class="btn btn-primary">
              {% trans "Upload photo" %}
            </a>
          </div>

          <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-3">
            {% for photo in photos %}
              <div class="col">
                <div class="card">
                  <div style="height: 200px; overflow: hidden;">
                    <img 
                      src="{{ photo.image.url }}" 
                      alt="Photo of {{ pet.name }}"
                      style="object-fit: cover; width:100%; height:100%;"
                    >
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <!-- VACCINATIONS TAB -->
      {% if active_tab == "vaccinations" %}
        <div class="tab-pane fade show active" id="vaccinations">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">{% trans "Vaccination Log" %}</h5>
            <a href="{% url 'pets:vaccination_create' pet.id %}" class="btn btn-warning">
              {% trans "Add Vaccination" %}
            </a>
          </div>
          <table class="table table-bordered table-sm">
            <thead>
              <tr>
                <th>{% trans "Date Administered" %}</th>
                <th>{% trans "Vaccine Name" %}</th>
                <th>{% trans "Next Due Date" %}</th>
                <th>{% trans "Notes" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for vac in vaccinations %}
                <tr>
                  <td>{{ vac.date_administered }}</td>
                  <td>{{ vac.vaccine_name }}</td>
                  <td>{{ vac.next_due_date|default:"-" }}</td>
                  <td>{{ vac.notes|default:"-" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}

      <!-- DOCUMENTS TAB -->
      {% if active_tab == "documents" %}
        <div class="tab-pane fade show active" id="documents">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">{% trans "Pet Documents" %}</h5>
            <a href="{% url 'pets:document_upload' pet.id %}" class="btn btn-info">
              {% trans "Add Document" %}
            </a>
          </div>
          <table class="table table-hover table-sm">
            <thead>
              <tr>
                <th>{% trans "Document Date" %}</th>
                <th>{% trans "Type" %}</th>
                <th>{% trans "Description" %}</th>
                <th>{% trans "File" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for doc in documents %}
                <tr>
                  <td>{{ doc.doc_date }}</td>
                  <td>{{ doc.get_doc_type_display }}</td>
                  <td>{{ doc.description|default:"-" }}</td>
                  <td>
                    <a href="{{ doc.doc_file.url }}" target="_blank">
                      {% trans "Download" %}
                    </a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
